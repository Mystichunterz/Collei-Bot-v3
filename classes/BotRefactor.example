//----------------------
//  imports
//----------------------
import { Client, Collection } from 'discord.js';
import CommandsHandler from './handlers/commands_handler.js';
import EventsHandler from './handlers/events_handler.js';
import ResponsesHandler from './handlers/responses_handler.js';
import ButtonsHandler from './handlers/buttons_handler.js';
import SlashCommandsHandler from './handlers/slash_commands_handler.js';
import { botConfig } from "../config/bot_config.js";

//----------------------
//  config
//----------------------
const serverId = botConfig.primaryServerId;

//----------------------
//  logging utility
//----------------------
function logSuccess(message) {
  console.log(`\x1b[32m%s\x1b[0m`, message);
}

function logError(context, error) {
  console.error(`Failed to ${context}:`, error);
}

//----------------------
//  main
//----------------------
class Bot extends Client {
  constructor(args) {
    super(args);

    // Setting up collections
    this.commands = new Collection();
    this.aliases = new Collection();
    this.cooldowns = new Collection();
    this.events = new Collection();
    this.responses = new Collection();
    this.buttons = new Collection();
    this.slash_commands = new Collection();

    // Setting up handlers
    this.commandsHandler = new CommandsHandler(this);
    this.eventsHandler = new EventsHandler(this);
    this.responsesHandler = new ResponsesHandler(this);
    this.buttonsHandler = new ButtonsHandler(this);
    this.slashCommandsHandler = new SlashCommandsHandler(this);

    // Misc properties
    this.prefix = args.prefix;
  }

  async start(token) {
    try {
      await Promise.all([
        this.commandsHandler.loadCommands(),
        this.eventsHandler.loadEvents(),
        this.responsesHandler.loadResponses(),
        this.buttonsHandler.loadButtons()
      ]);
      logSuccess('All components loaded!');

      logSuccess('Now logging in...');
      await super.login(token);
      logSuccess('Logged in! Now loading Slash Commands...');
      
      try {
        await this.slashCommandsHandler.loadSlashCommands(serverId);
        logSuccess('Slash Commands Loaded!');
      } catch (error) {
        logError('load Slash Commands', error);
      }

    } catch (error) {
      logError('load initial components', error);
    }
  }

  getCommand(commandName) {
    let command = this.commands.get(commandName) || this.commands.get(this.aliases.get(commandName));
    return command;
  }

  getSlashCommand(slashCommandName) {
    return this.slash_commands.get(slashCommandName) || this.slash_commands.get(this.aliases.get(slashCommandName));
  }

  getResponse(responseName) {
    return this.responses.get(this.aliases.get(responseName));
  }

  getButton(buttonName) {
    return this.buttons.get(buttonName);
  }
}

//----------------------
//  export
//----------------------
export default Bot;
